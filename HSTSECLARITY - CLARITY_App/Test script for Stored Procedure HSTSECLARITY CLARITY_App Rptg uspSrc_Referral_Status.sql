USE [CLARITY_App]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

DECLARE @StartDate SMALLDATETIME,
        @EndDate SMALLDATETIME,
		@DepartmentGrouperColumn VARCHAR(12),
		@DepartmentGrouperNoValue VARCHAR(25),
		@InsertIntoString NVARCHAR(1000),
		@SelectString NVARCHAR(MAX),
		@ParmDefinition NVARCHAR(500),
        @in_pods_servLine VARCHAR(MAX),
        @in_depid VARCHAR(MAX)

SET @StartDate = '5/1/2020 00:00 AM'
SET @EndDate = '5/31/2020 00:00 AM'

SET @DepartmentGrouperColumn = 'service_line'
--SET @DepartmentGrouperColumn = 'pod_name'

SET @DepartmentGrouperNoValue = '(No Service Line Defined)'
--SET @DepartmentGrouperNoValue = '(No Pod Defined)'

--ALTER PROCEDURE [Rptg].[uspSrc_Referral_Status]
--       (
--        @StartDate SMALLDATETIME = NULL,
--        @EndDate SMALLDATETIME = NULL,
--		@DepartmentGrouperColumn VARCHAR(12),
--		@DepartmentGrouperNoValue VARCHAR(25),
--        @in_pods_servLine VARCHAR(MAX),
--        @in_depid VARCHAR(MAX)
--	   )
--AS
/****************************************************************************************************************************************
WHAT: Create procedure Rptg.uspSrc_Referral_Status
WHO : Tom Burgan
WHEN: 06/02/2020
WHY : Referral Status report
----------------------------------------------------------------------------------------------------------------------------------------
INFO:
      INPUTS:   CLARITY_App.ETL.fn_ParmParse
	            CLARITY.dbo.REFERRAL
                CLARITY.dbo.REFERRAL_3
				CLARITY.dbo.PATIENT
				CLARITY.dbo.CLARITY_DEP
				CLARITY.dbo.CLARITY_SER
				CLARITY.dbo.ZC_SPECIALTY
				CLARITY.dbo.ZC_RFL_TYPE
				CLARITY.dbo.ZC_RFL_CLASS
				CLARITY.dbo.ZC_RFL_STATUS
				CLARITY.dbo.REFERRAL_SOURCE
				CLARITY.dbo.REFERRAL_HIST
                CLARITY.dbo.CLARITY_EMP
				CLARITY.dbo.ZC_RFL_HST_CHG_TYP
				CLARITY.dbo.V_SCHED_APPT
				CLARITY_App.Rptg.vwDim_Date
                CLARITY_App.Rptg.vwRef_MDM_Location_Master_EpicSvc

      OUTPUTS:
                CLARITY_App.Rptg.uspSrc_Referral_Status
----------------------------------------------------------------------------------------------------------------------------------------
MODS:     06/02/2020--TMB-- Create new stored procedure
*****************************************************************************************************************************************/

  SET NOCOUNT ON;

---------------------------------------------------
---Default referral creation date range is the current FYTD
  DECLARE @CurrDate SMALLDATETIME;

  SET @CurrDate = CAST(CAST(GETDATE() AS DATE) AS SMALLDATETIME);
    
  IF @StartDate IS NULL
      BEGIN
		SET @StartDate=CASE WHEN DATEPART(mm, @CurrDate)<7 
 	                        THEN CAST('07/01/'+CAST(DATEPART(yy, @CurrDate)-1 AS CHAR(4)) AS SMALLDATETIME)
                            ELSE CAST('07/01/'+CAST(DATEPART(yy, @CurrDate) AS CHAR(4)) AS SMALLDATETIME)
                       END;
	  END;

  IF @EndDate IS NULL
      BEGIN
        SET @EndDate = CAST(CAST(DATEADD(DAY, -1, @CurrDate) AS DATE) AS SMALLDATETIME);
      END;
----------------------------------------------------

DECLARE @locstartdate SMALLDATETIME,
        @locenddate SMALLDATETIME

SET @locstartdate = @StartDate
SET @locenddate   = @EndDate

IF OBJECT_ID('tempdb..#referrals ') IS NOT NULL
DROP TABLE #referrals

DECLARE @ServiceLine TABLE (ServiceLineName VARCHAR(150))

INSERT INTO @ServiceLine
(
    ServiceLineName
)
VALUES
--('(No Service Line Defined)'),
--('Digestive Health'),
--('Heart and Vascular'),
--('Medical Subspecialties'),
--('Musculoskeletal'),
--('Neurosciences and Behavioral Health'),
--('Oncology'),
--('Ophthalmology'),
--('Primary Care'),
--('Surgical Subspecialties'),
--('Transplant'),
--('Womens and Childrens')
--('(No Service Line Defined)')
--('Medical Subspecialties')
--('Digestive Health')
--('Womens and Childrens')
--('Ophthalmology')
--('Unknown')
('Primary Care')
;

SELECT @in_pods_servLine = COALESCE(@in_pods_servLine+',' ,'') + CAST(ServiceLineName AS VARCHAR(MAX))
FROM @ServiceLine

--SELECT @in_pods_servLine

DECLARE @Pod TABLE (PodName VARCHAR(100))

INSERT INTO @Pod
(
    PodName
)
VALUES
--('(No Pod Defined)'),
--('Cancer'),
--('Musculoskeletal'),
--('Primary Care'),
--('Surgical Procedural Specialties'),
--('Transplant'),
--('Medical Specialties'),
--('Radiology'),
--('Heart and Vascular Center'),
--('Neurosciences and Psychiatry'),
--('Women''s and Children''s'),
--('CPG'),
--('UVA Community Cancer POD'),
--('Digestive Health'),
--('Ophthalmology'),
--('Community Medicine')
--('Medical Specialties')
('Digestive Health')
;

--SELECT @in_pods_servLine = COALESCE(@in_pods_servLine+',' ,'') + CAST(PodName AS VARCHAR(MAX))
--FROM @Pod

--SELECT @in_pods_servLine

DECLARE @Department TABLE (DepartmentId NUMERIC(18,0))

INSERT INTO @Department
(
    DepartmentId
)
VALUES
--(10232001) -- ALTV DIALYSIS
--,(10201001) -- AMBP DIALYSIS
--,(10280003) -- AUBL HEART AND VASC LB
--,(10280004) -- AUBL PEDIATRICS
--,(10280016) -- AUBL PEDS DEVELOPMENT
--,(10280009) -- AUBL URO PEDS
--,(10280005) -- AUBL UVA CANC CTR AUG
--,(10280008) -- AUBL UVA CANC INF AUG
--,(10280800) -- AUBL UVA CANC LAB AUG
--,(10280012) -- AUBL UVA CARD RHYTHM
--,(10280002) -- AUBL UVA ECHO
--,(10280007) -- AUBL UVA NUCLEAR
--,(10280010) -- AUBL UVA PEDS RESP
--,(10280001) -- AUBL UVA SPTY CARE
--,(10280015) -- AUBL VASCULAR SURGERY
--,(10204001) -- AUMC DIALYSIS
--,(10204015) -- AUMC PLASTIC SURGERY
--,(10353003) -- AUPN SP CARE ENDO
--,(10353001) -- AUPN SP CARE NEPH
--,(10353002) -- AUPN SP CARE PFT
--,(10353004) -- AUPN SP CARE PULM
--,(10353005) -- AUPN SP CARE RHEU
--,(10353006) -- AUPN SP CARE URO
--,(10271002) -- BRLH NEUROLOGY
--,(10271001) -- BRLH PEDS DEVELOPMENT
--,(10206001) -- CHHC CONTINUUM 
--,(10205001) -- COL COLONNADES MED ASC
--,(10297001) -- CONS OUTSIDE UVA
--,(10390001) -- CPBE COMMONWEALTH MED
--,(10390004) -- CPBE DERMATOLOGY
--,(10390005) -- CPBE ENDOCRINE
--,(10390003) -- CPBE RAD DIAGNOSTIC
--,(10275003) -- CPBR ALLERGY
--,(10275001) -- CPBR FAMILY CARE
--,(10275002) -- CPBR PEDIATRICS
--,(10275006) -- CPBR PEDS CARDIOLOGY
--,(10275008) -- CPBR PEDS FITNESS CL
--,(10275004) -- CPBR PEDS NEPHROLOGY
--,(10275005) -- CPBR PEDS UROLOGY
--,(10257004) -- CPNM ENDOCRINE
--,(10257001) -- CPNM MADISON PRIMARY C
--,(10273001) -- CPOD COMMONWEALTH MED
--,(10369009) -- CPSA CARDIAC SURGERY
--,(10369001) -- CPSA CARDIOLOGY
--,(10369002) -- CPSA ECHO LAB
--,(10369005) -- CPSA MED NUCLEAR
--,(10369004) -- CPSA STRESS LAB
--,(10369006) -- CPSA VASC LAB
--,(10295005) -- CPSE CH CANC CTR
--,(10295006) -- CPSE CH CANC INF
--,(10295008) -- CPSE RAD ONC CL
--,(10295002) -- CPSE UVA HOPE CANC CP
--,(10272009) -- CPSL RAD MAMMOGRAPHY
--,(10293024) -- CPSN UVA OBGYN
--,(10293031) -- CPSN UVA ORTHO SPINE
--,(10293029) -- CPSN UVA ORTHOPEDICS
--,(10293026) -- CPSN UVA SURG BREAST
--,(10293025) -- CPSN UVA SURGICAL SVCS
--,(10293027) -- CPSN UVA UROLOGY
--,(10276004) -- CPSS PEDIATRICS
--,(10276008) -- CPSS UVA OBGYN
--,(10274001) -- CPST FAMILY PRACTICE
--,(10337001) -- CVAB PMR WORKMED
--,(10341009) -- CVPE MED NEPHROLOGY
--,(10341004) -- CVPE PMR
--,(10341007) -- CVPE PRIMARY CARE CL
--,(10341002) -- CVPE UVA RHEU INF PNTP
--,(10341001) -- CVPE UVA RHEU PANTOPS
--,(10306004) -- CVPJ PLASTIC SURGERY
--,(10306001) -- CVPJ UVA CANC CTR PTP
--,(10306003) -- CVPJ UVA CANC INF PTP
--,(10306800) -- CVPJ UVA CANC LAB PTP
--,(10339001) -- CVPM MED WESTMINSTER
--,(10338001) -- CVPP OTOLARYNGOLOGY
--,(10363002) -- CVSL PAIN MANAGEMENT
--,(10387005) -- CVSM OBGYN CL
--,(10387006) -- CVSM PEDS DEVELOPMENT
--,(10387002) -- CVSM PEDS RESPIRATORY 
--,(10387001) -- CVSM PRIMARY CARE
--,(10399001) -- CVSN ENDOCRINE
--,(10299002) -- CVSR ENDOCRINE
--,(10299001) -- CVSR NEPHROLOGY
--,(10405001) -- CVWK PRIMARY CARE
--,(10210042) -- ECCC DERMATOLOGY WEST
--,(10210055) -- ECCC ENDOCRINE EAST
--,(10210035) -- ECCC GYN ONC WOMENS
--,(10210001) -- ECCC HEM ONC EAST
--,(10210002) -- ECCC HEM ONC WEST
--,(10210014) -- ECCC HEM ONC WOMENS
--,(10210004) -- ECCC INFUSION CENTER
--,(10210019) -- ECCC MED DHC CL
--,(10210028) -- ECCC MED DHC EAST CL
--,(10210053) -- ECCC NEPHROLOGY EAST
--,(10210054) -- ECCC NEPHROLOGY WEST
--,(10210043) -- ECCC NEURO EAST
--,(10210030) -- ECCC NEURO WEST
--,(10210044) -- ECCC NSURG EAST
--,(10210032) -- ECCC NSURG WEST
--,(10210026) -- ECCC OTO CL EAST
--,(10210038) -- ECCC PAIN MANAGEMENT
--,(10210006) -- ECCC PALLIATIVE CLINIC
--,(10210040) -- ECCC PALLIATIVE EAST
--,(10210057) -- ECCC PHYSMED&REHB WMS
--,(10210017) -- ECCC PSY CL 1FL
--,(10210007) -- ECCC RAD CT
--,(10210023) -- ECCC RAD E&M CL EAST
--,(10210045) -- ECCC RAD E&M CL WEST
--,(10210060) -- ECCC RAD E&M CL WMS
--,(10210018) -- ECCC RAD NUC MED CL
--,(10210008) -- ECCC RAD NUCLEAR
--,(10210013) -- ECCC RAD ONC CLINIC
--,(10210005) -- ECCC RAD ONC THERAPY
--,(10210009) -- ECCC RAD PET
--,(10210015) -- ECCC RONC PROCEDURE RM
--,(10210012) -- ECCC RX
--,(10210022) -- ECCC SURG ONC EAST
--,(10210029) -- ECCC SURG ONC WEST
--,(10210051) -- ECCC UROLOGY EAST
--,(10210052) -- ECCC UROLOGY WEST
--,(10359001) -- ECON ECONSULT
--,(10211012) -- F415 ALLERGY OTO
--,(10211008) -- F415 AUDIOLOGY
--,(10211002) -- F415 DIABETES ED & MGT
--,(10211006) -- F415 ENDOCRINE
--,(10211013) -- F415 MED PITUITARY
--,(10211021) -- F415 NEUROSURGERY
--,(10211010) -- F415 NSRG SPINE CTR
--,(10211009) -- F415 ORTHO HAND CENTER
--,(10211018) -- F415 ORTHO SPINE CTR
--,(10211005) -- F415 OTOLARYNGOLOGY
--,(10211025) -- F415 PEDS PITUITARY
--,(10211019) -- F415 PMR SPINE CTR
--,(10211003) -- F415 RHEUMATOLOGY
--,(10211028) -- F415 SPEECH OTO
--,(10211004) -- F415 UNIV PHYS
--,(10211016) -- F415 UVAI CT
--,(10211001) -- F415 UVAI DIAGNOSTIC
--,(10211015) -- F415 UVAI MRI
--,(10211017) -- F415 UVAI ULTRASOUND
--,(10212015) -- F500 CARDIAC REHAB
--,(10212016) -- F500 CARDIOLOGY
--,(10212018) -- F500 CONT PELVIC SGY
--,(10212009) -- F500 ECG
--,(10212010) -- F500 ECHO LAB
--,(10212019) -- F500 ENDOCRINOLOGY
--,(10212003) -- F500 NEUROLOGY
--,(10212014) -- F500 PULM FUNC LAB
--,(10212011) -- F500 RHYTHM
--,(10212012) -- F500 STRESS LAB
--,(10212017) -- F500 UROLOGY
--,(10212013) -- F500 VASCULAR LAB
--,(10213003) -- F515 OCCUPATIONAL THER
--,(10213002) -- F515 PHYSICAL THERAPY
--,(10214002) -- F545 ORTHOPAEDICS FL 1
--,(10214013) -- F545 ORTHOPAEDICS FL 3
--,(10214001) -- F545 PAIN MANAGEMENT
--,(10214003) -- F545 PHYSICAL MED&RHB
--,(10214011) -- F545 SPORTS MED FL 1
--,(10214014) -- F545 SPORTS MED FL 3
--,(10214012) -- F545 UVAI DEXA
--,(10214006) -- F545 UVAI FLUORO
--,(10214007) -- F545 UVAI MRI
--,(10214008) -- F545 UVAI ULTRASOUND
--,(10307002) -- FBFH PEDS CARD
--,(10318001) -- FCRT FLUVANNA CORR RCF
--,(10215001) -- FLKS FAMILY MEDICINE
--,(10408001) -- FOFR NEUROSURGERY
--,(10391001) -- FOVP NEUROSURGERY
--,(10350001) -- FVSM DIALYSIS
--,(10395002) -- GAJM RAD CL & VEIN CL
--,(10395001) -- GAJM VEIN PROGRAM
--,(10364001) -- HBJW PEDS FITNESS CL
--,(10216002) -- HBMA UVA PED CARD CL
--,(10385001) -- HBQC NEUROSURGERY
--,(10281002) -- HMDY CVL HOME DIALYSIS
--,(10281003) -- HMDY FRM HOME DIALYSIS
--,(10376004) -- HYHB NEUROSURGERY
--,(10248001) -- JABA JEFFERSON ABA
--,(10217004) -- JPA DENTISTRY
--,(10217001) -- JPA EMPLOYEE SAME DAY
--,(10217007) -- JPA PSY THERAPY UMA
--,(10217002) -- JPA SLEEP LAB
--,(10217006) -- JPA TOXICOLOGY CL
--,(10217003) -- JPA UNIV MED ASSOCS
--,(10282871) -- LAB CULPEPER MEDICAL
--,(10282802) -- LAB ECCC CANCER CENTER
--,(10222002) -- LBCS DIALYSIS
--,(10267003) -- LBRA PEDS GENETIC
--,(10267001) -- LBRA PEDS PULMONARY
--,(10277002) -- LGGH RPC OBGYN CL
--,(10277001) -- LGGH WILDERNESS MEDCTR
--,(10220002) -- LOID MED A LOUISA RCF
--,(10220001) -- LOID MEDICAL ASSOC
--,(10226001) -- MMAM MOBILE MAMMOGRAPH
--,(10227002) -- MOSR RAD ONC CLINIC
--,(10227001) -- MOSR RAD ONC THERAPY
--,(10370001) -- NFCL UVA PCARD TXP CL
--,(10208001) -- NGCR FAMILY MEDICINE
--,(10234001) -- NLSC FAMILY MEDICINE
--,(10228010) -- NRDG ADULT PSYCHIATRY
--,(10228007) -- NRDG ALLERGY
--,(10228013) -- NRDG CARDIOLOGY
--,(10228012) -- NRDG COMMUNITY MED
--,(10228008) -- NRDG MAMMOGRAPHY
--,(10228003) -- NRDG MIDLIFE
--,(10228026) -- NRDG OPHTHALMOLOGY FL2
--,(10228002) -- NRDG OPHTHALMOLOGY FL3
--,(10228011) -- NRDG PEDIATRICS
--,(10228021) -- NRDG RAD CL & VEIN CL
--,(10228001) -- NRDG UNIV PHYS WOMEN
--,(10228020) -- NRDG VASC LAB
--,(10228019) -- NRDG VEIN PROGRAM
--,(10229001) -- OIVW PSY CHILD&FAMILY
--,(10230001) -- ORUL DIALYSIS
--,(10230009) -- ORUL MED CARD
--,(10230006) -- ORUL MED GEN DEMP
--,(10230005) -- ORUL MED NEPHROLOGY
--,(10230002) -- ORUL PEDIATRICS
--,(10230003) -- ORUL RAD DIAGNOSTIC
--,(10230004) -- ORUL UNIV PHYSICIANS
--,(10377001) -- PAMS PRIMARY CARE
--,(10361004) -- RMBR PEDS GENETICS CL
--,(10361001) -- RMBR UVA PCARD CL
--,(10361002) -- RMBR UVA PCARD ECHO
--,(10361003) -- RMBR UVA PCARD RHYT
--,(10374001) -- ROFR KIDNEY TRANSPLANT
--,(10260003) -- RONK UROLOGY PEDS
--,(10236001) -- SDGR FAMILY MEDICINE
--,(10380001) -- STAB PEDIATRICS
--,(10292001) -- STHL STUDENT HEALTH
--,(10292800) -- STHL STUDENT HEALTH LB
--,(10372001) -- STOH DIALYSIS
--,(10311001) -- SVRB SALEM VETS RCF
--,(10221007) -- TCIR TC2A
--,(10221001) -- TCIR TC2B
--,(10221005) -- TCIR UVAI CT
--,(10221004) -- TCIR UVAI MRI
--,(10221006) -- TCIR UVAI ULTRASOUND
--,(10237001) -- TSDE PROSTHETICS/ORTCS
--,(10279001) -- UHMR ATHLETIC TRNG RM
--,(10243917) -- UVA ANESTHESIA MD
--,(99999014) -- UVA EPICARE LINK
--,(99999029) -- UVA GENETIC COUNSELING
--,(99999012) -- UVA INFECTION PREV
--,(99999024) -- UVA PATIENT&GUEST SVC
--,(99999043) -- UVA POPULATION HEALTH
--,(99999003) -- UVA REG DIETITIANS
--,(99999011) -- UVA RESEARCH
--,(10354080) -- UVBB CARDIAC SURGERY
--,(10354012) -- UVBB DEV PEDS CL FL 4
--,(10354044) -- UVBB DEV PEDS CL FL 5
--,(10354049) -- UVBB DEV PEDS CL FL 6
--,(10354019) -- UVBB GEN PEDIATRIC FL6
--,(10354035) -- UVBB MATERNAL FETAL CL
--,(10354047) -- UVBB MED CARD CONGEN
--,(10354073) -- UVBB NEUROLOGY PED FL4
--,(10354037) -- UVBB NEUROLOGY PED FL5
--,(10354034) -- UVBB NEUROSURG PEDS CL
--,(10354040) -- UVBB OBGYN FETAL CARE
--,(10354900) -- UVBB OPSC
--,(10354902) -- UVBB OPSC OR
--,(10354028) -- UVBB ORTHO PEDS CL
--,(10354011) -- UVBB ORTHO PEDS P&O
--,(10354081) -- UVBB ORTHODONTICS
--,(10354036) -- UVBB OTOL PEDS CL
--,(10354089) -- UVBB PEDS ALLERGY FL6
--,(10354026) -- UVBB PEDS AUDIO
--,(10354059) -- UVBB PEDS CARD CL FL 3
--,(10354018) -- UVBB PEDS CARD CL FL 6
--,(10354009) -- UVBB PEDS CARD STRESS
--,(10354008) -- UVBB PEDS DENTISTRY
--,(10354043) -- UVBB PEDS DIABETES CL
--,(10354075) -- UVBB PEDS ENDOCRINE F5
--,(10354021) -- UVBB PEDS ENDOCRINE F6
--,(10354060) -- UVBB PEDS FETAL ECHO
--,(10354014) -- UVBB PEDS GASTRO CL
--,(10354017) -- UVBB PEDS GENETICS CL
--,(10354084) -- UVBB PEDS HEM ONC
--,(10354023) -- UVBB PEDS ID CL
--,(10354006) -- UVBB PEDS INFUSION
--,(10354039) -- UVBB PEDS NEONATE FL 5
--,(10354042) -- UVBB PEDS PALLIATIVE
--,(10354074) -- UVBB PEDS PULM FL5
--,(10354025) -- UVBB PEDS PULM FL6
--,(10354024) -- UVBB PEDS RENAL CL FL5
--,(10354013) -- UVBB PEDS RHEUM CL
--,(10354016) -- UVBB PEDS SURGERY CL
--,(10354055) -- UVBB PEDS TRANSPLANT
--,(10354032) -- UVBB PHYSICAL THER FL4
--,(10354054) -- UVBB PLASTIC SURG FL6
--,(10354051) -- UVBB PMR PEDS CL
--,(10354027) -- UVBB PSYCH PEDS CL
--,(10354007) -- UVBB PULM FUNC TESTING
--,(10354001) -- UVBB RAD DIAGNOSTIC
--,(10354003) -- UVBB RAD ULTRASOUND
--,(10354005) -- UVBB TEEN YOUNG AD CTR
--,(10354029) -- UVBB UROLOGY PEDS FL 4
--,(10354076) -- UVBB UROLOGY PEDS FL 5
--,(10250002) -- UVBR NEUROLOGY
--,(10250001) -- UVBR NEUROSURGERY
--,(10240003) -- UVBR ORAL SURGERY
--,(10290001) -- UVCP RONC FOCUSED US
--,(10241002) -- UVDV NEUROPSYCH TEST
--,(10241001) -- UVDV PLASTIC SURGERY
--,(10381005) -- UVEC ERC RX
--,(10381003) -- UVEC RAD CT
--,(10381001) -- UVEC RAD DIAGNOSTIC
--,(10381004) -- UVEC RAD MRI
--,(10381002) -- UVEC RAD ULTRASOUND
--,(10243051) -- UVHE 3 CENTRAL
--,(10243052) -- UVHE 3 EAST
--,(10243089) -- UVHE 3 NORTH
--,(10243053) -- UVHE 3 WEST
--,(10243054) -- UVHE 4 CENTRAL CV
--,(10243110) -- UVHE 4 CENTRAL TXP
--,(10243055) -- UVHE 4 EAST
--,(10243091) -- UVHE 4 NORTH
--,(10243057) -- UVHE 4 WEST
--,(10243058) -- UVHE 5 CENTRAL
--,(10243059) -- UVHE 5 EAST
--,(10243090) -- UVHE 5 NORTH
--,(10243119) -- UVHE 5 NORTH SSU
--,(10243060) -- UVHE 5 WEST
--,(10243061) -- UVHE 6 CENTRAL
--,(10243062) -- UVHE 6 EAST
--,(10243120) -- UVHE 6 EAST SSU
--,(10243092) -- UVHE 6 NORTH
--,(10243063) -- UVHE 6 WEST
--,(10243064) -- UVHE 7 CENTRAL
--,(10243118) -- UVHE 7 NORTH NICU
--,(10243113) -- UVHE 7 NORTH OB
--,(10243065) -- UVHE 7 WEST
--,(10243101) -- UVHE 7EAST ACUTE
--,(10243103) -- UVHE 7NORTH ACUTE
--,(10243066) -- UVHE 8 CENTRAL OB
--,(10243094) -- UVHE 8 NORTH OB
--,(10243115) -- UVHE 8 NORTH ONC
--,(10243068) -- UVHE 8 WEST
--,(10243096) -- UVHE 8 WEST STEM CELL
--,(10243114) -- UVHE ALLERGY DHC
--,(10243012) -- UVHE CARDIAC CATH LAB
--,(10243112) -- UVHE CARDIAC SURGERY
--,(10243050) -- UVHE CARDIAC TRANSITN
--,(10243035) -- UVHE CORONARY CARE
--,(10243022) -- UVHE DIALYSIS
--,(10243003) -- UVHE DIGESTIVE HEALTH
--,(10243009) -- UVHE ECG
--,(10243008) -- UVHE ECHO LAB
--,(10243085) -- UVHE ELECTROCONVLSV TH
--,(10243013) -- UVHE ELECTROPHYSIOLOGY
--,(10243026) -- UVHE EMERGENCY DEPT
--,(10243912) -- UVHE ENDOBRONC PREPOST
--,(10243911) -- UVHE ENDOBRONC PROC
--,(10243020) -- UVHE GI MOTILITY
--,(10243081) -- UVHE HUMAN IMMUNE CTR
--,(10243005) -- UVHE HYPERBARIC OXYGEN
--,(10243037) -- UVHE LABOR & DELIVERY
--,(10243097) -- UVHE MED CARD CL
--,(10243088) -- UVHE MED STEM CELL
--,(10243038) -- UVHE MEDICAL ICU
--,(10243041) -- UVHE NEUR ICU
--,(10243025) -- UVHE NEURORADIOLOGY
--,(10243040) -- UVHE NEWBORN ICU
--,(10243044) -- UVHE NEWBORN NURSERY
--,(10243902) -- UVHE OR
--,(10243107) -- UVHE P&O
--,(10243043) -- UVHE PEDIATRIC ICU
--,(10243109) -- UVHE PEDS NEONATE NICU
--,(10243900) -- UVHE PERIOP
--,(10243907) -- UVHE PETC
--,(10243034) -- UVHE PHARMACY
--,(10243100) -- UVHE PICU 7NORTH
--,(10243015) -- UVHE RAD ANGIOGRAPHY
--,(10243016) -- UVHE RAD CT
--,(10243030) -- UVHE RAD DIAG E&M
--,(10243017) -- UVHE RAD DIAGNOSTIC
--,(10243084) -- UVHE RAD FLUOROSCOPY
--,(10243117) -- UVHE RAD IMAGE MGMT
--,(10243019) -- UVHE RAD MRI
--,(10243018) -- UVHE RAD NUCLEAR
--,(10243021) -- UVHE RAD ULTRASOUND
--,(10243031) -- UVHE RESPIRATORY THRPY
--,(10243047) -- UVHE SHORT STAY UNIT
--,(10243024) -- UVHE STRESS LAB
--,(10243087) -- UVHE SURG DIGESTIVE HL
--,(10243046) -- UVHE SURG TRAM ICU
--,(10243049) -- UVHE TCV POST OP
--,(10243104) -- UVHE VASC SURG
--,(10243006) -- UVHE VASCULAR LAB
--,(10379900) -- UVML ENDOBRONC PROC
--,(10239004) -- UVMS BREAST
--,(10239001) -- UVMS DIALYSIS
--,(10239026) -- UVMS ENDO TRANSPLANT
--,(10239024) -- UVMS ID TRANSPLANT
--,(10239023) -- UVMS MED GI CL NEPH
--,(10239003) -- UVMS NEPHROLOGY
--,(10239016) -- UVMS PLASTIC SURG SURG
--,(10239010) -- UVMS PSYCHIATRY
--,(10239014) -- UVMS RAD DIAGNOSTIC
--,(10239007) -- UVMS RAD MAMMOGRAPHY
--,(10239020) -- UVMS SURG TRANSPLANT
--,(10239015) -- UVMS SURGERY
--,(10239019) -- UVMS TRANSPLANT KIDNEY
--,(10239017) -- UVMS TRANSPLANT LIVER
--,(10239018) -- UVMS TRANSPLANT LUNG
--,(10242050) -- UVPC ALLERGY PULM
--,(10242049) -- UVPC CARDIAC SURGERY
--,(10242008) -- UVPC CARDIOLOGY
--,(10242005) -- UVPC DERMATOLOGY
--,(10242051) -- UVPC DIGESTIVE HEALTH
--,(10242017) -- UVPC ECHO LAB
--,(10242002) -- UVPC EEG
--,(10242003) -- UVPC EMG
--,(10242012) -- UVPC FAMILY MEDICINE
--,(10242007) -- UVPC NEUROLOGY
--,(10242031) -- UVPC NEUROPSYCH
--,(10242044) -- UVPC NEUROSURGERY
--,(10242006) -- UVPC OB-GYN
--,(10242042) -- UVPC PED NEUROPSYCH
--,(10242041) -- UVPC PEDS NEUROLOGY
--,(10242028) -- UVPC PEDS RESP MED
--,(10242027) -- UVPC PEDS SURGERY
--,(10242040) -- UVPC PMR NEUROLOGY
--,(10242045) -- UVPC PSY CL FMED
--,(10242019) -- UVPC PULM FUNC LAB
--,(10242018) -- UVPC PULMONARY
--,(10242001) -- UVPC TELEMEDICINE
--,(10244028) -- UVWC GASTRO ID
--,(10244016) -- UVWC INFECTIOUS DIS
--,(10244023) -- UVWC MED GI CL
--,(10244029) -- UVWC OBGYN ID
--,(10244004) -- UVWC OPHTHALMOLOGY
--,(10244018) -- UVWC PFT TX
--,(10244026) -- UVWC PSYCHIATRY ID
--,(10244020) -- UVWC RAD MAMMO CL
--,(10244006) -- UVWC UROLOGY
--,(10246005) -- WALL ENDO MED FAMILY
--,(10246006) -- WALL FAM MED PSYCH
--,(10246001) -- WALL FAMILY MEDICINE
--,(10246004) -- WALL MED DH FAM MED
--,(10246007) -- WALL PEDIATRICS
--,(10403001) -- WARA PRIMARY CARE
--,(10245001) -- WAYB PRIMARY CARE
--,(10396008) -- WCCC PEDS CARD ECHO
--,(10396007) -- WCCC PEDS CARDIOLOGY
--,(10396011) -- WCCC PEDS FITNESS CL
--,(10396003) -- WCCC PEDS GASTRO CL
--,(10396010) -- WCCC PEDS GENETICS CL
--,(10396012) -- WCCC PEDS HEM ONC
--,(10396001) -- WCCC PEDS NEPHROLOGY
--,(10396002) -- WCCC PLASTIC SURG CL
--,(10396004) -- WCCC UROLOGY PEDS CL
--,(10355006) -- WCPD PEDS GENETICS CL
--,(10355005) -- WCPD PEDS NEPHROLOGYCL
--,(10355008) -- WCPD UROLOGY PEDS CL
--,(10355001) -- WCPD UVA PED CARD CL
--,(10409001) -- WFWB PEDIATRICS
--,(10397001) -- WSCA PRIMARY CARE
--,(10239005) -- Z(OLD)UVMS CANCER CTR
--,(10348039) -- ZCSC ALLERGY
--,(10348024) -- ZCSC BREAST
--,(10348003) -- ZCSC CARDIOLOGY
--,(10348004) -- ZCSC DERMATOLOGY
--,(10348005) -- ZCSC ENDOCRINE
--,(10348021) -- ZCSC HEART AND VASC LB
--,(10348007) -- ZCSC NEPHROLOGY
--,(10348008) -- ZCSC NEUROLOGY
--,(10348034) -- ZCSC NEURORAD E&M
--,(10348026) -- ZCSC OBGYN
--,(10348032) -- ZCSC OBGYN URO
--,(10348023) -- ZCSC ORTHO SPINE FL 1
--,(10348022) -- ZCSC ORTHO SPORTS MED
--,(10348013) -- ZCSC ORTHOPEDICS FL 1
--,(10348036) -- ZCSC ORTHOPEDICS FL 2
--,(10348027) -- ZCSC PEDS ORTHO
--,(10348010) -- ZCSC PHYSICAL MED REH
--,(10348014) -- ZCSC PRIMARY CARE
--,(10348011) -- ZCSC PULMONARY
--,(10348012) -- ZCSC PULMONARY FUNC
--,(10348040) -- ZCSC RAD E&M
--,(10348015) -- ZCSC UROLOGY
--,(10348016) -- ZCSC UVAI CT
--,(10348019) -- ZCSC UVAI DIAGNOSTIC
--,(10348020) -- ZCSC UVAI MAMMOGRAPHY
--,(10348017) -- ZCSC UVAI MRI
--,(10348018) -- ZCSC UVAI US
--,(10247001) -- ZXCP DIALYSIS
--,(10240002) -- ZZZZ BEHAVIORAL MED
--,(10354045) -- ZZZZ DEV PEDS 5C CL
--,(10341003) -- ZZZZ P&S CARE CL
--,(10354015) -- ZZZZ PEDS ONCOLOGY CL
--,(10243011) -- ZZZZ SURG TCV
--,(10348025) -- ZZZZ TCV
--(10228012) -- NRDG COMMUNITY MED
(10211004) -- F415 UNIV PHYS
;

SELECT @in_depid = COALESCE(@in_depid+',' ,'') + CAST(DepartmentId AS VARCHAR(MAX))
FROM @Department

----SELECT @in_depid

--;WITH cte_pods_servLine (pod_Service_Line) AS (SELECT Param FROM CLARITY_App.ETL.fn_ParmParse(@in_pods_servLine, ','))

--SELECT * FROM cte_pods_servLine

--SELECT DISTINCT REFERRAL.REFD_BY_DEPT_ID AS DepartmentId, dep.DEPARTMENT_NAME AS DepartmentName
--FROM CLARITY.dbo.REFERRAL
--LEFT OUTER JOIN CLARITY.dbo.REFERRAL_3
--ON REFERRAL.REFERRAL_ID=REFERRAL_3.REFERRAL_ID
--LEFT OUTER JOIN CLARITY_App.Rptg.vwRef_MDM_Location_Master_EpicSvc mdm
--ON REFERRAL.REFD_BY_DEPT_ID = mdm.epic_department_id
--LEFT OUTER JOIN Rptg.vwCLARITY_DEP dep
--ON dep.DEPARTMENT_ID = REFERRAL.REFD_BY_DEPT_ID
--WHERE (REFERRAL_3.AUTH_CERT_YN IS NULL OR REFERRAL_3.AUTH_CERT_YN='N')
--AND REFERRAL.ACTUAL_NUM_VISITS IS NOT NULL
--AND mdm.epic_department_id IS NOT NULL
--AND (REFERRAL.EXP_DATE >= @locstartdate AND REFERRAL.EXP_DATE <= @locenddate)
--AND COALESCE(mdm.service_line,'(No Service Line Defined)') IN (SELECT pod_Service_Line FROM cte_pods_servLine)
--ORDER BY dep.DEPARTMENT_NAME

IF OBJECT_ID('tempdb..#ReferredByDepartment') IS NOT NULL DROP TABLE tempdb..#ReferredByDepartment

CREATE TABLE #ReferredByDepartment (DepartmentId NUMERIC(18,0))

SET @InsertIntoString = N';WITH cte_pods_servLine (pod_Service_Line) AS (SELECT Param FROM CLARITY_App.ETL.fn_ParmParse(@PodServiceLine, '','')) INSERT INTO #ReferredByDepartment SELECT DISTINCT REFERRAL.REFD_BY_DEPT_ID AS DepartmentId FROM CLARITY.dbo.REFERRAL LEFT OUTER JOIN CLARITY.dbo.REFERRAL_3 ON REFERRAL.REFERRAL_ID=REFERRAL_3.REFERRAL_ID LEFT OUTER JOIN CLARITY_App.Rptg.vwRef_MDM_Location_Master_EpicSvc mdm ON REFERRAL.REFD_BY_DEPT_ID = mdm.epic_department_id WHERE (REFERRAL_3.AUTH_CERT_YN IS NULL OR REFERRAL_3.AUTH_CERT_YN=''N'') AND REFERRAL.ACTUAL_NUM_VISITS IS NOT NULL AND mdm.epic_department_id IS NOT NULL AND (REFERRAL.EXP_DATE >= @CreateStartDate AND REFERRAL.EXP_DATE <= @CreateEndDate) AND COALESCE(' + @DepartmentGrouperColumn + ',''' + @DepartmentGrouperNoValue + ''') IN (SELECT pod_Service_Line FROM cte_pods_servLine) ORDER BY REFERRAL.REFD_BY_DEPT_ID';
SET @ParmDefinition = N'@CreateStartDate SMALLDATETIME, @CreateEndDate SMALLDATETIME, @PodServiceLine VARCHAR(MAX)';
EXECUTE sp_executesql @InsertIntoString, @ParmDefinition, @CreateStartDate=@locstartdate, @CreateEndDate=@locenddate, @PodServiceLine=@in_pods_servLine;

--SELECT dept.DepartmentId, dep.DEPARTMENT_NAME FROM #ReferredByDepartment dept
--LEFT OUTER JOIN rptg.vwCLARITY_DEP dep
--ON dep.DEPARTMENT_ID = dept.DepartmentId
--ORDER BY dep.DEPARTMENT_NAME

--DECLARE @Department TABLE (DepartmentId NUMERIC(18,0))

--INSERT INTO @Department
--(
--    DepartmentId
--)
--SELECT DepartmentId
--FROM #ReferredByDepartment
--;

--SELECT @in_depid = COALESCE(@in_depid+',' ,'') + CAST(DepartmentId AS VARCHAR(MAX))
--FROM @Department

--SELECT dept.DepartmentId, dep.DEPARTMENT_NAME
--FROM @Department dept
--LEFT OUTER JOIN Rptg.vwCLARITY_DEP dep
--ON dep.DEPARTMENT_ID = dept.DepartmentId

--SELECT @in_depid

--DECLARE @SelectString NVARCHAR(MAX),
--		@ParmDefinition NVARCHAR(500)

SELECT DISTINCT
   CAST('Referral Status' AS VARCHAR(50)) AS event_type,
   1 AS event_count,
   REFERRAL.EXP_DATE AS event_date,
   date_dim.fmonth_num,
   date_dim.Fyear_num,
   date_dim.FYear_name,
   CAST(LEFT(DATENAME(MM, date_dim.day_date), 3) + ' ' + CAST(DAY(date_dim.day_date) AS VARCHAR(2)) AS VARCHAR(10)) AS report_period,
   CAST(CAST(date_dim.day_date AS DATE) AS SMALLDATETIME) AS report_date,
   REFERRAL.REFD_BY_DEPT_ID AS epic_department_id,
   REFERRING_DEP.DEPARTMENT_NAME AS epic_department_name,
   CAST(PATIENT.PAT_MRN_ID AS INTEGER) AS person_id,
   PATIENT.PAT_NAME AS person_name,
   REFERRAL_SOURCE.REF_PROVIDER_ID AS provider_id,
   REFERRING_SER.PROV_NAME AS provider_name,
   REFERRAL.REFERRAL_ID,
   REFERRAL.ENTRY_DATE,
   AUTH_CHANGE.CHANGE_DATETIME AS AUTH_DATE,
   ZC_RFL_CLASS.NAME AS REFERRAL_CLASS,
   ZC_RFL_TYPE.NAME AS REFERRAL_TYPE,
   REFERRAL.RFL_STATUS_C,
   ZC_RFL_STATUS.NAME AS RFL_STATUS_NAME,
   REFERRAL.ACTUAL_NUM_VISITS AS ACTUAL_NUM_COMPLETED_VISITS,
   REFERRAL.SCHED_NUM_VISITS AS NUM_SCHEDULED_VISITS,
   CLARITY_DEP.DEPARTMENT_ID AS REFERRED_TO_DEPT_ID,
   CLARITY_DEP.DEPARTMENT_NAME AS REFERRED_TO_DEPT_NAME,
   CLARITY_SER.PROV_ID AS REFERRED_TO_PROV_ID,
   CLARITY_SER.PROV_NAME AS REFERRED_TO_PROV_NAME,
   ZC_SPECIALTY.NAME AS REFERRED_TO_PROV_SPEC,
   PATIENT.PAT_NAME AS PATIENT_NAME,
   SCHED_CHANGE.CHANGE_DATETIME AS RFL_CHANGE_DTTM,
   SCHED_CHANGE.CHANGE_TYPE_C AS RFL_CHANGE_TYPE_C,
   SCHED_CHANGE.CHANGE_TYPE_NAME AS RFL_CHANGE_TYPE,
   SCHED_CHANGE.CHANGE_USER_ID AS RFL_CHANGE_USER_ID,
   SCHED_CHANGE.CHANGE_USER_NAME AS RFL_CHANGE_USER,
   SCHED_CHANGE.PREVIOUS_VALUE AS RFL_CHANGE_TEXT,
   RFL_APPTS.ACTUAL_CNT AS SCHEDULED_VISITS,
   RFL_APPTS.APPT_MADE_DTTM AS FIRST_APPT_MADE,
   RFL_APPTS.APPT_DATE AS FIRST_APPT,
   RFL_APPTS.COMPLETED_CNT,
   RFL_APPTS.CANCELED_CNT,
   mdm.service_line_id,
   mdm.service_line,
   mdm.POD_ID,
   mdm.PFA_POD

INTO #referrals

FROM 
   CLARITY.dbo.REFERRAL
   LEFT OUTER JOIN CLARITY.dbo.REFERRAL_3 ON REFERRAL.REFERRAL_ID=REFERRAL_3.REFERRAL_ID
   LEFT OUTER JOIN CLARITY.dbo.PATIENT ON REFERRAL.PAT_ID = PATIENT.PAT_ID
   LEFT OUTER JOIN CLARITY.dbo.CLARITY_DEP ON REFERRAL.REFD_TO_DEPT_ID = CLARITY_DEP.DEPARTMENT_ID
   LEFT OUTER JOIN CLARITY.dbo.CLARITY_SER ON REFERRAL.REFERRAL_PROV_ID = CLARITY_SER.PROV_ID 
   LEFT OUTER JOIN CLARITY.dbo.ZC_SPECIALTY ON REFERRAL.PROV_SPEC_C = ZC_SPECIALTY.SPECIALTY_C
   LEFT OUTER JOIN CLARITY.dbo.ZC_RFL_TYPE ON REFERRAL.RFL_TYPE_C = ZC_RFL_TYPE.RFL_TYPE_C
   LEFT OUTER JOIN CLARITY.dbo.ZC_RFL_CLASS ON REFERRAL.RFL_CLASS_C = ZC_RFL_CLASS.RFL_CLASS_C
   LEFT OUTER JOIN CLARITY.dbo.ZC_RFL_STATUS ON REFERRAL.RFL_STATUS_C = ZC_RFL_STATUS.RFL_STATUS_C
   LEFT OUTER JOIN CLARITY.dbo.REFERRAL_SOURCE ON REFERRAL.REFERRING_PROV_ID = REFERRAL_SOURCE.REFERRING_PROV_ID
   LEFT OUTER JOIN CLARITY.dbo.CLARITY_SER AS REFERRING_SER  ON REFERRING_SER.PROV_ID = REFERRAL_SOURCE.REF_PROVIDER_ID
   LEFT OUTER JOIN CLARITY.dbo.CLARITY_DEP AS REFERRING_DEP  ON REFERRING_DEP.DEPARTMENT_ID = REFERRAL.REFD_BY_DEPT_ID
   LEFT OUTER JOIN
      ( SELECT REFERRAL_ID, CHANGE_DATETIME
         FROM CLARITY.dbo.REFERRAL_HIST
         WHERE REFERRAL_HIST.LINE = (	SELECT MAX(RFLHX.LINE) 
                                 FROM CLARITY.dbo.REFERRAL_HIST RFLHX
                                 WHERE RFLHX.CHANGE_TYPE_C IN (53,39)
                                 AND RFLHX.REFERRAL_ID = REFERRAL_HIST.REFERRAL_ID)) AS AUTH_CHANGE ON AUTH_CHANGE.REFERRAL_ID = REFERRAL.REFERRAL_ID

   LEFT OUTER JOIN
      ( SELECT rh.REFERRAL_ID, rh.LINE, rh.CHANGE_DATE, rh.CHANGE_TYPE_C, rhct.NAME AS CHANGE_TYPE_NAME, rh.CHANGE_USER_ID, emp.NAME AS CHANGE_USER_NAME, rh.PREVIOUS_VALUE, rh.CHANGE_DATETIME
         FROM CLARITY.dbo.REFERRAL_HIST rh
         LEFT OUTER JOIN CLARITY.dbo.CLARITY_EMP emp ON emp.USER_ID = rh.CHANGE_USER_ID
         LEFT OUTER JOIN CLARITY.dbo.ZC_RFL_HST_CHG_TYP rhct ON rhct.CHANGE_TYPE_C = rh.CHANGE_TYPE_C
         WHERE rh.LINE = (	SELECT MAX(RFLHX.LINE) 
                                 FROM CLARITY.dbo.REFERRAL_HIST RFLHX
                                 LEFT OUTER JOIN CLARITY.dbo.ZC_RFL_HST_CHG_TYP rhct ON rhct.CHANGE_TYPE_C    = RFLHX.CHANGE_TYPE_C
                                 WHERE RFLHX.CHANGE_USER_ID NOT IN ('RFLEOD','RTEUSERIN','CADENCEEOD','KBSQL')
								 AND (rhct.NAME LIKE '%Schedul%' AND rhct.NAME NOT IN ('RFLEOD','CADENCEEOD'))
                                 AND RFLHX.REFERRAL_ID = rh.REFERRAL_ID)) AS SCHED_CHANGE ON SCHED_CHANGE.REFERRAL_ID = REFERRAL.REFERRAL_ID
   
   LEFT OUTER JOIN 
      ( SELECT RFL.REFERRAL_ID RFL_ID,
         COUNT(DISTINCT RFL_ENC.PAT_ENC_CSN_ID) ACTUAL_CNT,
         MIN(RFL_ENC.APPT_MADE_DATE) APPT_MADE_DATE,
         MIN(RFL_ENC.APPT_MADE_DTTM) APPT_MADE_DTTM,
         MIN(RFL_ENC.CONTACT_DATE) APPT_DATE,
		 SUM(CASE WHEN RFL_ENC.APPT_STATUS_C = 1 THEN 1 ELSE 0 END) SCHEDULED_CNT,
		 SUM(CASE WHEN RFL_ENC.APPT_STATUS_C = 2 THEN 1 ELSE 0 END) COMPLETED_CNT,
		 SUM(CASE WHEN RFL_ENC.APPT_STATUS_C = 3 THEN 1 ELSE 0 END) CANCELED_CNT,
		 SUM(CASE WHEN RFL_ENC.APPT_STATUS_C = 4 THEN 1 ELSE 0 END) NO_SHOW_CNT,
		 SUM(CASE WHEN RFL_ENC.APPT_STATUS_C = 6 THEN 1 ELSE 0 END) ARRIVED_CNT
         FROM CLARITY.dbo.REFERRAL RFL
         INNER JOIN CLARITY.dbo.V_SCHED_APPT RFL_ENC ON RFL_ENC.REFERRAL_ID = RFL.REFERRAL_ID
         GROUP BY RFL.REFERRAL_ID) RFL_APPTS ON RFL_APPTS.RFL_ID = REFERRAL.REFERRAL_ID
    LEFT OUTER JOIN
    (
	    SELECT day_date,
               fmonth_num,
               Fyear_num,
               FYear_name
        FROM CLARITY_App.Rptg.vwDim_Date
    ) date_dim
	ON (date_dim.day_date = CAST(REFERRAL.EXP_DATE AS SMALLDATETIME))
    LEFT OUTER JOIN Rptg.vwRef_MDM_Location_Master_EpicSvc mdm
    ON REFERRAL.REFD_BY_DEPT_ID = mdm.epic_department_id
   
WHERE (REFERRAL_3.AUTH_CERT_YN IS NULL OR REFERRAL_3.AUTH_CERT_YN='N')
	  AND REFERRAL.ACTUAL_NUM_VISITS IS NOT NULL
	  AND (REFERRAL.EXP_DATE >= @locstartdate AND REFERRAL.EXP_DATE <= @locenddate)
--ORDER BY SCHED_CHANGE.CHANGE_DATETIME
--       , REFERRAL.REFERRAL_ID
/*
SET @SelectString = N';WITH cte_pods_servLine (pod_Service_Line)
AS
(
SELECT Param FROM CLARITY_App.ETL.fn_ParmParse(@PodServiceLine, '','')
)
,cte_depid (DepartmentId)
AS
(
SELECT Param FROM CLARITY_App.ETL.fn_ParmParse(@DepartmentId, '','')
)
SELECT DISTINCT
   CAST(''Completed Referral'' AS VARCHAR(50)) AS event_type,
   1 AS event_count,
   REFERRAL.EXP_DATE AS event_date,
   date_dim.fmonth_num,
   date_dim.Fyear_num,
   date_dim.FYear_name,
   CAST(LEFT(DATENAME(MM, date_dim.day_date), 3) + '' '' + CAST(DAY(date_dim.day_date) AS VARCHAR(2)) AS VARCHAR(10)) AS report_period,
   CAST(CAST(date_dim.day_date AS DATE) AS SMALLDATETIME) AS report_date,
   REFERRAL.REFD_BY_DEPT_ID AS epic_department_id,
   REFERRING_DEP.DEPARTMENT_NAME AS epic_department_name,
   CAST(PATIENT.PAT_MRN_ID AS INTEGER) AS person_id,
   PATIENT.PAT_NAME AS person_name,
   REFERRAL_SOURCE.REF_PROVIDER_ID AS provider_id,
   REFERRING_SER.PROV_NAME AS provider_name,
   REFERRAL.REFERRAL_ID,
   REFERRAL.ENTRY_DATE,
   AUTH_CHANGE.CHANGE_DATETIME AS AUTH_DATE,
   ZC_RFL_CLASS.NAME AS REFERRAL_CLASS,
   ZC_RFL_TYPE.NAME AS REFERRAL_TYPE,
   CLARITY_DEP.DEPARTMENT_ID AS REFERRED_TO_DEPT_ID,
   CLARITY_DEP.DEPARTMENT_NAME AS REFERRED_TO_DEPT_NAME,
   CLARITY_SER.PROV_ID AS REFERRED_TO_PROV_ID,
   CLARITY_SER.PROV_NAME AS REFERRED_TO_PROV_NAME,
   ZC_SPECIALTY.NAME AS REFERRED_TO_PROV_SPEC,
   PATIENT.PAT_NAME AS PATIENT_NAME,
   SCHED_CHANGE.CHANGE_DATETIME AS RFL_CHANGE_DTTM,
   SCHED_CHANGE.CHANGE_TYPE_NAME AS RFL_CHANGE_TYPE,
   SCHED_CHANGE.CHANGE_USER_ID AS RFL_CHANGE_USER_ID,
   SCHED_CHANGE.CHANGE_USER_NAME AS RFL_CHANGE_USER,
   SCHED_CHANGE.PREVIOUS_VALUE AS RFL_CHANGE_TEXT,
   RFL_APPTS.ACTUAL_CNT AS SCHEDULED_VISITS,
   RFL_APPTS.APPT_MADE_DTTM AS FIRST_APPT_MADE,
   RFL_APPTS.APPT_DATE AS FIRST_APPT,
   RFL_APPTS.COMPLETED_CNT,
   RFL_APPTS.CANCELED_CNT,
   mdm.service_line_id,
   mdm.service_line,
   mdm.POD_ID,
   mdm.PFA_POD 

FROM 
   CLARITY.dbo.REFERRAL
   LEFT OUTER JOIN CLARITY.dbo.REFERRAL_3 ON REFERRAL.REFERRAL_ID=REFERRAL_3.REFERRAL_ID
   LEFT OUTER JOIN CLARITY.dbo.PATIENT ON REFERRAL.PAT_ID = PATIENT.PAT_ID
   LEFT OUTER JOIN CLARITY.dbo.CLARITY_DEP ON REFERRAL.REFD_TO_DEPT_ID = CLARITY_DEP.DEPARTMENT_ID
   LEFT OUTER JOIN CLARITY.dbo.CLARITY_SER ON REFERRAL.REFERRAL_PROV_ID = CLARITY_SER.PROV_ID 
   LEFT OUTER JOIN CLARITY.dbo.ZC_SPECIALTY ON REFERRAL.PROV_SPEC_C = ZC_SPECIALTY.SPECIALTY_C
   LEFT OUTER JOIN CLARITY.dbo.ZC_RFL_TYPE ON REFERRAL.RFL_TYPE_C = ZC_RFL_TYPE.RFL_TYPE_C
   LEFT OUTER JOIN CLARITY.dbo.ZC_RFL_CLASS ON REFERRAL.RFL_CLASS_C = ZC_RFL_CLASS.RFL_CLASS_C
   LEFT OUTER JOIN CLARITY.dbo.ZC_RFL_STATUS ON REFERRAL.RFL_STATUS_C = ZC_RFL_STATUS.RFL_STATUS_C
   LEFT OUTER JOIN CLARITY.dbo.REFERRAL_SOURCE ON REFERRAL.REFERRING_PROV_ID = REFERRAL_SOURCE.REFERRING_PROV_ID
   LEFT OUTER JOIN CLARITY.dbo.CLARITY_SER AS REFERRING_SER  ON REFERRING_SER.PROV_ID = REFERRAL_SOURCE.REF_PROVIDER_ID
   LEFT OUTER JOIN CLARITY.dbo.CLARITY_DEP AS REFERRING_DEP  ON REFERRING_DEP.DEPARTMENT_ID = REFERRAL.REFD_BY_DEPT_ID
   LEFT OUTER JOIN
      ( SELECT REFERRAL_ID, CHANGE_DATETIME
         FROM CLARITY.dbo.REFERRAL_HIST
         WHERE REFERRAL_HIST.LINE = (	SELECT MAX(RFLHX.LINE) 
                                 FROM CLARITY.dbo.REFERRAL_HIST RFLHX
                                 WHERE RFLHX.CHANGE_TYPE_C IN (53,39)
                                 AND RFLHX.REFERRAL_ID = REFERRAL_HIST.REFERRAL_ID)) AS AUTH_CHANGE ON AUTH_CHANGE.REFERRAL_ID = REFERRAL.REFERRAL_ID

   LEFT OUTER JOIN
      ( SELECT rh.REFERRAL_ID, rh.LINE, rh.CHANGE_DATE, rh.CHANGE_TYPE_C, rhct.NAME AS CHANGE_TYPE_NAME, rh.CHANGE_USER_ID, emp.NAME AS CHANGE_USER_NAME, rh.PREVIOUS_VALUE, rh.CHANGE_DATETIME
         FROM CLARITY.dbo.REFERRAL_HIST rh
         LEFT OUTER JOIN CLARITY.dbo.CLARITY_EMP emp ON emp.USER_ID = rh.CHANGE_USER_ID
         LEFT OUTER JOIN CLARITY.dbo.ZC_RFL_HST_CHG_TYP rhct ON rhct.CHANGE_TYPE_C = rh.CHANGE_TYPE_C
         WHERE rh.LINE = (	SELECT MAX(RFLHX.LINE) 
                                 FROM CLARITY.dbo.REFERRAL_HIST RFLHX
                                 LEFT OUTER JOIN CLARITY.dbo.ZC_RFL_HST_CHG_TYP rhct ON rhct.CHANGE_TYPE_C    = RFLHX.CHANGE_TYPE_C
                                 WHERE RFLHX.CHANGE_USER_ID NOT IN (''RFLEOD'',''RTEUSERIN'',''CADENCEEOD'',''KBSQL'')
								 AND (rhct.NAME LIKE ''%Schedul%'' AND rhct.NAME NOT IN (''RFLEOD'',''CADENCEEOD''))
                                 AND RFLHX.REFERRAL_ID = rh.REFERRAL_ID)) AS SCHED_CHANGE ON SCHED_CHANGE.REFERRAL_ID = REFERRAL.REFERRAL_ID
   
   LEFT OUTER JOIN 
      ( SELECT RFL.REFERRAL_ID RFL_ID,
         COUNT(DISTINCT RFL_ENC.PAT_ENC_CSN_ID) ACTUAL_CNT,
         MIN(RFL_ENC.APPT_MADE_DATE) APPT_MADE_DATE,
         MIN(RFL_ENC.APPT_MADE_DTTM) APPT_MADE_DTTM,
         MIN(RFL_ENC.CONTACT_DATE) APPT_DATE,
		 SUM(CASE WHEN RFL_ENC.APPT_STATUS_C = 1 THEN 1 ELSE 0 END) SCHEDULED_CNT,
		 SUM(CASE WHEN RFL_ENC.APPT_STATUS_C = 2 THEN 1 ELSE 0 END) COMPLETED_CNT,
		 SUM(CASE WHEN RFL_ENC.APPT_STATUS_C = 3 THEN 1 ELSE 0 END) CANCELED_CNT,
		 SUM(CASE WHEN RFL_ENC.APPT_STATUS_C = 4 THEN 1 ELSE 0 END) NO_SHOW_CNT,
		 SUM(CASE WHEN RFL_ENC.APPT_STATUS_C = 6 THEN 1 ELSE 0 END) ARRIVED_CNT
         FROM CLARITY.dbo.REFERRAL RFL
         INNER JOIN CLARITY.dbo.V_SCHED_APPT RFL_ENC ON RFL_ENC.REFERRAL_ID = RFL.REFERRAL_ID
         GROUP BY RFL.REFERRAL_ID) RFL_APPTS ON RFL_APPTS.RFL_ID = REFERRAL.REFERRAL_ID
   LEFT OUTER JOIN
    (
	    SELECT day_date,
               fmonth_num,
               Fyear_num,
               FYear_name
        FROM CLARITY_App.Rptg.vwDim_Date
    ) date_dim
	ON (date_dim.day_date = CAST(REFERRAL.EXP_DATE AS SMALLDATETIME))
    LEFT OUTER JOIN Rptg.vwRef_MDM_Location_Master_EpicSvc mdm
    ON REFERRAL.REFD_BY_DEPT_ID = mdm.epic_department_id
   
WHERE (REFERRAL_3.AUTH_CERT_YN IS NULL OR REFERRAL_3.AUTH_CERT_YN=''N'')
      AND REFERRAL.ACTUAL_NUM_VISITS IS NOT NULL
	  AND (REFERRAL.EXP_DATE >= @CompletedStartDate AND REFERRAL.EXP_DATE <= @CompletedEndDate)
      AND (COALESCE(mdm.' + @DepartmentGrouperColumn + ',''' + @DepartmentGrouperNoValue + ''') IN (SELECT pod_Service_Line FROM cte_pods_servLine)) AND (REFERRAL.REFD_BY_DEPT_ID IN (SELECT DepartmentId FROM cte_depid))

ORDER BY SCHED_CHANGE.CHANGE_DATETIME
       , REFERRAL.REFERRAL_ID';
SET @ParmDefinition = N'@CompletedStartDate SMALLDATETIME, @CompletedEndDate SMALLDATETIME, @PodServiceLine VARCHAR(MAX), @DepartmentId VARCHAR(MAX)';
EXECUTE sp_executesql @SelectString, @ParmDefinition, @CompletedStartDate=@locstartdate, @CompletedEndDate=@locenddate, @PodServiceLine=@in_pods_servLine, @DepartmentId=@in_depid;
*/
/*
SELECT
       epic_department_id,
       epic_department_name,
       REFERRAL_ID,
	   event_type,
       event_count,
       event_date,
       ENTRY_DATE,
       AUTH_DATE,
       fmonth_num,
       Fyear_num,
       FYear_name,
       report_period,
       report_date,
       person_id,
       person_name,
       provider_id,
       provider_name,
       REFERRAL_CLASS,
       REFERRAL_TYPE,
       RFL_STATUS_C,
       RFL_STATUS_NAME,
       REFERRED_TO_DEPT_ID,
       REFERRED_TO_DEPT_NAME,
       REFERRED_TO_PROV_ID,
       REFERRED_TO_PROV_NAME,
       REFERRED_TO_PROV_SPEC,
       PATIENT_NAME,
       RFL_CHANGE_DTTM,
       RFL_CHANGE_TYPE_C,
       RFL_CHANGE_TYPE,
       RFL_CHANGE_USER_ID,
       RFL_CHANGE_USER,
       RFL_CHANGE_TEXT,
       SCHEDULED_VISITS,
       FIRST_APPT_MADE,
       FIRST_APPT,
       COMPLETED_CNT,
       CANCELED_CNT,
       service_line_id,
       service_line,
       POD_ID,
       PFA_POD
FROM #referrals
--WHERE epic_department_id IS NOT NULL
WHERE epic_department_id = 10228012
--ORDER BY epic_department_id
--       , REFERRAL_ID
--	   , AUTH_DATE
ORDER BY epic_department_id
       , ENTRY_DATE
       , REFERRAL_ID
*/
SELECT
       REFERRAL_ID,
	   event_date,
       ENTRY_DATE,
       AUTH_DATE,
       REFERRAL_CLASS,
       REFERRAL_TYPE,
       RFL_STATUS_C,
       RFL_STATUS_NAME,
	   ACTUAL_NUM_COMPLETED_VISITS,
	   NUM_SCHEDULED_VISITS,
       REFERRED_TO_DEPT_NAME,
       SCHEDULED_VISITS,
       FIRST_APPT_MADE,
       FIRST_APPT,
       COMPLETED_CNT,
       CANCELED_CNT
FROM #referrals
--WHERE epic_department_id IS NOT NULL
WHERE epic_department_id = 10228012
--ORDER BY ENTRY_DATE
--       , REFERRAL_ID
ORDER BY RFL_STATUS_NAME
       , ACTUAL_NUM_COMPLETED_VISITS DESC
       , ENTRY_DATE
       , REFERRAL_ID

GO


